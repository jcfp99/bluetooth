SELECT BU.NAME Business_Unit,  BOOK.BOOK_TYPE_CODE Book,
LEASE.LEASE_ID Lease_Id, 
LEASE.LEASE_NUMBER Lease_Number,
LEASE.DESCRIPTION Description,
LEASE.CONTRACT_NUMBER Contract_Number,
--LEASE.LESSOR_ID Lessor_Id,
LESSOR1.INCOME_TAX_ID Lessor_Id,
HZ.PARTY_NAME Lessor_Name,
TO_CHAR(LEASE.LEASE_START_DATE,'YYYY-MM-DD') Lease_Start_Date,
--LEASE.LEASE_START_DATE Lease_Start_Date,
(select V1.MEANING from FND_LOOKUP_VALUES V1 where V1.LOOKUP_CODE = LEASE.PAYMENT_FREQUENCY_CODE and V1.Language = 'E') Payment_Frecuency,
(select V2.MEANING from FND_LOOKUP_VALUES V2 where V2.LOOKUP_CODE = LEASE.PAYMENT_OPTION_TYPE_CODE and V2.Language = 'E') Payment_Option,
LEASE.ATTRIBUTE1 Source_Contract,
LEASE.ATTRIBUTE2 Currency_Source_Contract,
LEASE.ATTRIBUTE3 CAI_Item_id,
LEASE.ATTRIBUTE_NUMBER1 Version_Contract,
LEASE.ATTRIBUTE_NUMBER2 TRM_Source_Contract,

/*CATEGORY.SEGMENT1 Asset_Category_Main,
CATEGORY.SEGMENT2 Asset_Category_Less,*/
--HIST.ATTRIBUTE_CATEGORY_CODE Category_Main_Less,
CONCAT(CATB.SEGMENT1,CONCAT( '-',CATB.SEGMENT2)) Category_Main_Less,

--FSCHED.ASSET_DESCRIPTION Asset_Description,
(SELECT FSCHED1.ASSET_DESCRIPTION FROM FA_LEASE_SCHEDULES FSCHED1 WHERE
FSCHED.LEASE_ID = FSCHED1.LEASE_ID 
--AND FSCHED1.SCHEDULE_TYPE_CODE= 'L'
AND FSCHED1.ASSET_DESCRIPTION <> ' '
AND rownum = 1)Asset_Description,
FSCHED.ASSET_SCHEDULE_NUM Asset_Schedule_Num, 
FSCHED.ASSET_NUMBER  Asset_Number,

GL_CC.SEGMENT3 Departament,
GL_CC.SEGMENT6 Site,

TO_CHAR((SELECT MAX(SCHEITM.PERIOD_END_DATE) FROM FA_LEASE_SCHEDULE_ITEMS SCHEITM WHERE  SCHEITM.PAYMENT_TYPE_CODE = 'FA_PERIODIC_PAYMENT' AND SCHEITM.LEASE_SCHEDULE_ID = FSCHED.LEASE_SCHEDULE_ID),'YYYY-MM-DD') Lease_End_Date,

--BOOK.LEASE_END_DATE  Lease_End_Date,
FA_FASLSCSVEXP_XMLP_PKG.calculate_noncancel_period(LEASE.LEASE_START_DATE, BOOK.LEASE_END_DATE, BOOK.NON_CANCELLABLE_LIFE_IN_MONTHS) Noncancelable_Period_in_Months,
FA_FASLSCSVEXP_XMLP_PKG.calculate_extendable_period(LEASE.LEASE_START_DATE, BOOK.LEASE_END_DATE, 
BOOK.NON_CANCELLABLE_LIFE_IN_MONTHS, BOOK.EXTEND_PERIOD_IN_MONTHS) Extendable_Period_in_Months,
FA_FASLSCSVEXP_XMLP_PKG.calculate_extendable_period(LEASE.LEASE_START_DATE, BOOK.LEASE_END_DATE, BOOK.NON_CANCELLABLE_LIFE_IN_MONTHS, BOOK.TERMINAL_PERIOD_IN_MONTHS) Cancelable_Period_in_Months,
BOOK.LEASE_TERM Leasing_Terms,
FADH.CODE_COMBINATION_ID Expense_CC_Id,
BOOK.NEW_COST Book_Cost,
BOOK.NEW_LIABILITY_AMOUNT Book_Liability,
BOOK.GAIN_LOSS_AMOUNT Book_Gain_Loss,
BOOK.LEASE_TRANSACTION_TYPE_CODE Last_Transaction,
BK.ASSET_ID,
BK.LEASE_SCHEDULE_ID,

(SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM   FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE = 'FA_PERIODIC_PAYMENT'
AND FSCHEDITEM.INVOICE_DATE = (SELECT MAX(ITEMS_ED .INVOICE_DATE)  
     FROM FA_LEASE_SCHEDULE_ITEMS ITEMS_ED 
    WHERE ITEMS_ED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
      AND ITEMS_ED.PAYMENT_TYPE_CODE = 'FA_PERIODIC_PAYMENT'
      AND ITEMS_ED.INVOICE_DATE <=:P_END_DATE)) AS Periodic_Leasing_Payment,

(SELECT MAX(FSCHEDITEM.INTEREST_RATE) FROM     FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE = 'FA_PERIODIC_PAYMENT') AS Interest_Rate,

(SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM     FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE = 'FA_OTHER_PAYMENTS') AS Other_Payments,

(SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM   FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE = 'FA_VARIABLE_PAYMENT') AS Variable_Payments,

(SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM     FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE = 'FA_INITIAL_DIRECT_COSTS') AS Initial_Direct_Cost_Payment,

(SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM     FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE = 'FA_ADVANCED_PAYMENT') AS One_Time_Payment,

(SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM     FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE = 'FA_TERMINATION_PENALTY') AS Termination_Penalty_Payment,

--LEASE.ASSET_LIFE,
FMD.LIFE_IN_MONTHS Life_In_Months,
NVL((SELECT  DISTINCT 'Retirado' FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATHS.TRANSACTION_TYPE_CODE = 'FULL RETIREMENT'
),'En Uso') as IN_USE_FLAG,
--BK.DATE_EFFECTIVE IN_USE_DATE_EFFECTIVE,
--TO_CHAR(BK.DATE_EFFECTIVE,'YYYY-MM-DD') IN_USE_DATE_EFFECTIVE,
NVL((SELECT  MAX(TO_CHAR(FATHS.TRANSACTION_DATE_ENTERED,'YYYY-MM-DD')) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATHS.TRANSACTION_TYPE_CODE = 'FULL RETIREMENT'),
(SELECT  MAX(TO_CHAR(FATHS.CREATION_DATE,'YYYY-MM-DD')) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATHS.TRANSACTION_TYPE_CODE = 'ADDITION'
AND FATADJS.ADJUSTMENT_TYPE='COST'
AND FATHS.TRANSACTION_TYPE_CODE=FATADJS.SOURCE_TYPE_CODE)) IN_USE_DATE_EFFECTIVE,
/*(SELECT COUNT(PERIOD_COUNTER) FROM FA_DEPRN_DETAIL DEPRN_PER WHERE DEPRN_PER.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE AND DEPRN_PER.ASSET_ID = BK.ASSET_ID 
AND DEPRN_PER.DEPRN_AMOUNT >0
AND DEPRN_PER.DEPRN_RUN_DATE <= :P_END_DATE ) AS Depreciated_Periods,*/
((SELECT COUNT(DEPRN_PER.PERIOD_COUNTER) +CASE WHEN NVL(EXTRACT(MONTH FROM(FATH.AMORTIZATION_START_DATE)),0)=0
THEN 0 ELSE /*(MIN(DEPRN_PERIODS.PERIOD_NUM)-NVL(EXTRACT(MONTH FROM (FATH.TRANSACTION_DATE_ENTERED)),0))*/
TRUNC (MONTHS_BETWEEN 
   (FATH.CREATION_DATE,
    FATH.TRANSACTION_DATE_ENTERED)) END FROM FA_DEPRN_DETAIL DEPRN_PER, FA_DEPRN_PERIODS DEPRN_PERIODS WHERE DEPRN_PER.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE AND DEPRN_PER.ASSET_ID = BK.ASSET_ID AND (DEPRN_PER.YTD_DEPRN>0
OR DEPRN_PER.DEPRN_AMOUNT>0)
AND DEPRN_PER.BOOK_TYPE_CODE=DEPRN_PERIODS.BOOK_TYPE_CODE
AND DEPRN_PER.PERIOD_COUNTER=DEPRN_PERIODS.PERIOD_COUNTER
AND DEPRN_PERIODS.FISCAL_YEAR <= to_char(:P_END_DATE, 'YYYY')
AND DEPRN_PERIODS.PERIOD_NUM <=to_char(:P_END_DATE, 'MM')
AND DEPRN_PER.DEPRN_RUN_ID>0
 )/*+NVL((EXTRACT(MONTH FROM (FATH.AMORTIZATION_START_DATE))-EXTRACT(MONTH FROM (FATH.TRANSACTION_DATE_ENTERED))),0)*/) AS Depreciated_Periods,
/*FMD.LIFE_IN_MONTHS - (SELECT COUNT(PERIOD_COUNTER) FROM FA_DEPRN_DETAIL DEPRN_PER WHERE DEPRN_PER.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE AND DEPRN_PER.ASSET_ID = BK.ASSET_ID AND DEPRN_PER.DEPRN_AMOUNT >0
AND DEPRN_PER.DEPRN_RUN_DATE <= :P_END_DATE) AS Remaining_Life_Calculated,*/
FMD.LIFE_IN_MONTHS - (SELECT COUNT(DEPRN_PER.PERIOD_COUNTER) +CASE WHEN NVL(EXTRACT(MONTH FROM(FATH.AMORTIZATION_START_DATE)),0)=0
THEN 0 ELSE (MIN(DEPRN_PERIODS.PERIOD_NUM)-NVL(EXTRACT(MONTH FROM (FATH.TRANSACTION_DATE_ENTERED)),0)) END FROM FA_DEPRN_DETAIL DEPRN_PER, FA_DEPRN_PERIODS DEPRN_PERIODS WHERE DEPRN_PER.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE AND DEPRN_PER.ASSET_ID = BK.ASSET_ID AND (DEPRN_PER.YTD_DEPRN>0
OR DEPRN_PER.DEPRN_AMOUNT>0)
AND DEPRN_PER.BOOK_TYPE_CODE=DEPRN_PERIODS.BOOK_TYPE_CODE
AND DEPRN_PER.PERIOD_COUNTER=DEPRN_PERIODS.PERIOD_COUNTER
AND DEPRN_PERIODS.FISCAL_YEAR <= to_char(:P_END_DATE, 'YYYY')
AND DEPRN_PERIODS.PERIOD_NUM <=to_char(:P_END_DATE, 'MM')
 )  AS Remaining_Life_Calculated,

-- Inital Liability Value (Addition)
FATAD.ADJUSTMENT_AMOUNT Adj_Add_Liability,

-- Liability Adjustments (between report dates)
/*(SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY' 
AND FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'
AND FATHS.DATE_EFFECTIVE BETWEEN :P_START_DATE AND :P_END_DATE) AS Month_Liability_Adjustments,*/
NVL((SELECT (SUM(FATADJS.ADJUSTMENT_AMOUNT)*-1) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY' 
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT' OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATHS.TRANSACTION_DATE_ENTERED BETWEEN :P_START_DATE AND :P_END_DATE),0)+
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY' 
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT' OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATHS.TRANSACTION_DATE_ENTERED BETWEEN :P_START_DATE AND :P_END_DATE),0) AS Month_Liability_Adjustments,

-- All Historic Liability Adjustments
/*(SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY'
AND FATHS.DATE_EFFECTIVE <= :P_END_DATE )  AS Accum_Liability_Adjustments,*/
NVL((SELECT (SUM(FATADJS.ADJUSTMENT_AMOUNT)*-1) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT' OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE ),0)+
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT' OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE ),0)  AS Accum_Liability_Adjustments,

-- Report Dates Interest Payment Plan
(SELECT SUM(FATHS_EX.LEASE_INTEREST_AMOUNT)
FROM FA_LEASE_EXPENSE_DETAIL FATHS_EX, FA_DEPRN_PERIODS PER_EXP
WHERE FATHS_EX.ASSET_ID = BK.ASSET_ID 
AND FATHS_EX.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND ASSETS.ASSET_ID = BK.ASSET_ID
AND FATHS_EX.PERIOD_COUNTER =  PER_EXP.PERIOD_COUNTER
AND FATHS_EX.BOOK_TYPE_CODE = PER_EXP.BOOK_TYPE_CODE
AND :P_START_DATE <= PER_EXP.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER_EXP.CALENDAR_PERIOD_CLOSE_DATE)   AS Month_Interest_Amount_Amort,

-- Accum Interest Payment Plan
(SELECT SUM(FATHS_EX2.LEASE_INTEREST_AMOUNT)
FROM FA_LEASE_EXPENSE_DETAIL FATHS_EX2, FA_DEPRN_PERIODS PER_EXP
WHERE FATHS_EX2.ASSET_ID = BK.ASSET_ID 
AND FATHS_EX2.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND ASSETS.ASSET_ID = BK.ASSET_ID
AND FATHS_EX2.PERIOD_COUNTER =  PER_EXP.PERIOD_COUNTER
AND FATHS_EX2.BOOK_TYPE_CODE = PER_EXP.BOOK_TYPE_CODE
AND :P_END_DATE >= PER_EXP.CALENDAR_PERIOD_CLOSE_DATE) AS Accum_Interest_Amount_Amort,


-- Sumary of payment amount between report dates
(SELECT SUM(FATHS_EX2.LEASE_PAYMENT_AMOUNT)
FROM FA_LEASE_EXPENSE_DETAIL FATHS_EX2, FA_DEPRN_PERIODS PER_EXP2
WHERE FATHS_EX2.ASSET_ID = BK.ASSET_ID 
AND FATHS_EX2.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND ASSETS.ASSET_ID = BK.ASSET_ID
AND FATHS_EX2.PERIOD_COUNTER =  PER_EXP2.PERIOD_COUNTER
AND FATHS_EX2.BOOK_TYPE_CODE = PER_EXP2.BOOK_TYPE_CODE
AND :P_START_DATE <= PER_EXP2.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER_EXP2.CALENDAR_PERIOD_CLOSE_DATE) 
+
NVL((SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM     FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE IN( 'FA_OTHER_PAYMENTS', 'FA_VARIABLE_PAYMENT')
AND FSCHEDITEM.INVOICE_DATE <=:P_END_DATE
AND FSCHEDITEM.INVOICE_DATE >=:P_START_DATE
),0)
AS Lease_Payment_Amount_Amort,

-- Sum all payment amount in payment plan until End Report Date
(SELECT SUM(FATHS_EX3.LEASE_PAYMENT_AMOUNT)
FROM FA_LEASE_EXPENSE_DETAIL FATHS_EX3, FA_DEPRN_PERIODS PER_EXP3
WHERE FATHS_EX3.ASSET_ID = BK.ASSET_ID 
AND FATHS_EX3.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND ASSETS.ASSET_ID = BK.ASSET_ID
AND FATHS_EX3.PERIOD_COUNTER =  PER_EXP3.PERIOD_COUNTER
AND FATHS_EX3.BOOK_TYPE_CODE = PER_EXP3.BOOK_TYPE_CODE
AND :P_END_DATE >= PER_EXP3.CALENDAR_PERIOD_CLOSE_DATE) 
+
NVL((SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM     FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE IN( 'FA_OTHER_PAYMENTS', 'FA_VARIABLE_PAYMENT')
AND FSCHEDITEM.INVOICE_DATE <=:P_END_DATE
),0) AS Total_Payment_Amount,

-- Liability Balance
FATAD.ADJUSTMENT_AMOUNT + /*NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY' 
AND FATHS.DATE_EFFECTIVE <= :P_END_DATE),0) */
(NVL((SELECT (SUM(FATADJS.ADJUSTMENT_AMOUNT)*-1) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT' OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE ),0)+
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT' OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.ADJUSTMENT_TYPE = 'LEASE LIABILITY'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE ),0))
 + NVL((SELECT SUM(FATHS_EX2.LEASE_INTEREST_AMOUNT)
FROM FA_LEASE_EXPENSE_DETAIL FATHS_EX2, FA_DEPRN_PERIODS PER_EXP
WHERE FATHS_EX2.ASSET_ID = BK.ASSET_ID 
AND FATHS_EX2.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND ASSETS.ASSET_ID = BK.ASSET_ID
AND FATHS_EX2.PERIOD_COUNTER =  PER_EXP.PERIOD_COUNTER
AND FATHS_EX2.BOOK_TYPE_CODE = PER_EXP.BOOK_TYPE_CODE
AND :P_END_DATE >= PER_EXP.CALENDAR_PERIOD_CLOSE_DATE),0)  - (NVL((SELECT SUM(FATHS_EX3.LEASE_PAYMENT_AMOUNT)
FROM FA_LEASE_EXPENSE_DETAIL FATHS_EX3, FA_DEPRN_PERIODS PER_EXP3
WHERE FATHS_EX3.ASSET_ID = BK.ASSET_ID 
AND FATHS_EX3.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND ASSETS.ASSET_ID = BK.ASSET_ID
AND FATHS_EX3.PERIOD_COUNTER =  PER_EXP3.PERIOD_COUNTER
AND FATHS_EX3.BOOK_TYPE_CODE = PER_EXP3.BOOK_TYPE_CODE
AND :P_END_DATE >= PER_EXP3.CALENDAR_PERIOD_CLOSE_DATE),0)+
NVL((SELECT SUM(FSCHEDITEM.PAYMENT_AMOUNT) FROM     FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE IN( 'FA_OTHER_PAYMENTS', 'FA_VARIABLE_PAYMENT')
AND FSCHEDITEM.INVOICE_DATE <=:P_END_DATE
),0))  AS Liability_Balance,


-- Number of payments
CONCAT ((SELECT COUNT(FATHS_EX3.PERIOD_COUNTER) FROM FA_LEASE_EXPENSE_DETAIL FATHS_EX3, FA_DEPRN_PERIODS PER_EXP3
WHERE FATHS_EX3.ASSET_ID = BK.ASSET_ID 
AND FATHS_EX3.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS_EX3.PERIOD_COUNTER =  PER_EXP3.PERIOD_COUNTER
AND FATHS_EX3.BOOK_TYPE_CODE = PER_EXP3.BOOK_TYPE_CODE
--AND FATHS_EX3.LEASE_SOURCE_CODE = 'LB'
AND FATHS_EX3.LEASE_PAYMENT_AMOUNT >0
AND :P_END_DATE >= PER_EXP3.CALENDAR_PERIOD_CLOSE_DATE)  , CONCAT(' DE ', /*(SELECT MAX(FSCHEDITEM.NUMBER_OF_PAYMENTS) FROM   FA_LEASE_SCHEDULE_ITEMS FSCHEDITEM WHERE  BK.ASSET_ID = FSCHED.ASSET_ID AND FSCHED.LEASE_SCHEDULE_ID = FSCHEDITEM.LEASE_SCHEDULE_ID
AND FSCHEDITEM.PAYMENT_TYPE_CODE = 'FA_PERIODIC_PAYMENT')*/
FA_FASLSCSVEXP_XMLP_PKG.calculate_noncancel_period(LEASE.LEASE_START_DATE, BOOK.LEASE_END_DATE, BOOK.NON_CANCELLABLE_LIFE_IN_MONTHS))) AS Number_Of_Payment,

-- Cost Addition Amount
FATCS.ADJUSTMENT_AMOUNT Adj_Add_Cost,


-- Report Dates Cost Adjustments
/*(SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'COST' 
AND FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'
--AND FATHS.DATE_EFFECTIVE BETWEEN :P_START_DATE AND :P_END_DATE) 
AND FATHS.TRANSACTION_DATE_ENTERED BETWEEN :P_START_DATE AND :P_END_DATE) 
AS 
Month_Cost_Adjustments,*/
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'COST' 
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED BETWEEN :P_START_DATE AND :P_END_DATE),0)+
NVL((SELECT (SUM(FATADJS.ADJUSTMENT_AMOUNT)*-1) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'COST' 
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.TRANSACTION_DATE_ENTERED BETWEEN :P_START_DATE AND :P_END_DATE),0) AS Month_Cost_Adjustments,

-- All Historic Cost Adjustments
/*(SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'COST'
AND FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'
--AND FATHS.DATE_EFFECTIVE <= :P_END_DATE) 
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE) 
AS Accum_Cost_Adjustments,*/
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'COST'
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE),0)+ 
NVL((SELECT (SUM(FATADJS.ADJUSTMENT_AMOUNT)*-1) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'COST'
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE),0)AS Accum_Cost_Adjustments,

(SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'ADJUSTMENTS' 
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR')  AS Acum_Cost_Adjustments,

--Amortización Mes

(SELECT SUM(FATHS.DEPRN_AMOUNT) 
FROM FA_DEPRN_DETAIL FATHS, FA_DEPRN_PERIODS PER
WHERE   FATHS.ASSET_ID = BK.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATHS.PERIOD_COUNTER = PER.PERIOD_COUNTER
AND FATHS.DEPRN_SOURCE_CODE = 'D'
AND :P_START_DATE <= CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= CALENDAR_PERIOD_CLOSE_DATE) 
-
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'RESERVE' 
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED >= :P_START_DATE 
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE),0)AS Month_Deprn_Adjustments,

--Amortización Acum
/*
(SELECT FATHS.YTD_DEPRN
FROM  FA_DEPRN_DETAIL FATHS, FA_DEPRN_PERIODS PER
WHERE   FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATHS.PERIOD_COUNTER = PER.PERIOD_COUNTER
AND FATHS.DEPRN_SOURCE_CODE = 'D'
AND FATHS.DEPRN_AMOUNT <> 0
AND FATHS.PERIOD_COUNTER = (SELECT MAX(FATHS_AE.PERIOD_COUNTER)
FROM FA_DEPRN_DETAIL FATHS_AE
WHERE FATHS.BOOK_TYPE_CODE = FATHS_AE.BOOK_TYPE_CODE
AND FATHS.ASSET_ID = FATHS_AE.ASSET_ID
AND FATHS.DEPRN_AMOUNT <> 0
AND FATHS.PERIOD_COUNTER = FATHS_AE.PERIOD_COUNTER)
AND :P_START_DATE <= CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= CALENDAR_PERIOD_CLOSE_DATE
--AND :P_END_DATE >= CALENDAR_PERIOD_CLOSE_DATE
)AS Acum_Deprn_Adjustments,*/
--(SELECT MAX(FATHS.YTD_DEPRN)
--(SELECT MAX(FATHS.DEPRN_RESERVE)
/*(SELECT SUM(FATHS.DEPRN_AMOUNT)
FROM  FA_DEPRN_DETAIL FATHS, FA_DEPRN_PERIODS PER
WHERE   FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATHS.PERIOD_COUNTER = PER.PERIOD_COUNTER
AND FATHS.DEPRN_SOURCE_CODE = 'D'
AND FATHS.DEPRN_AMOUNT <> 0
AND :P_END_DATE >= CALENDAR_PERIOD_CLOSE_DATE
)-
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'RESERVE' 
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE),0)*/
(CASE WHEN (SELECT DISTINCT 'Y' FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'RESERVE' 
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE
)='Y'THEN 0 ELSE (SELECT SUM(FATHS.DEPRN_AMOUNT)+ SUM(FATHS.DEPRN_ADJUSTMENT_AMOUNT)
FROM  FA_DEPRN_DETAIL FATHS, FA_DEPRN_PERIODS PER
WHERE   FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATHS.PERIOD_COUNTER = PER.PERIOD_COUNTER
AND FATHS.DEPRN_SOURCE_CODE = 'D'
AND FATHS.DEPRN_AMOUNT <> 0
AND :P_END_DATE >= CALENDAR_PERIOD_CLOSE_DATE
)END)AS Acum_Deprn_Adjustments,

-- Deterioro Mes
/*
(SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) *-1
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_START_DATE <= PER.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE) AS Month_Impair_Adjustments,*/
(NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) *-1
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_START_DATE <= PER.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE
),0) +
/*NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_START_DATE <= PER.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0)*/
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR RESERVE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_START_DATE <= PER.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0)-
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR RESERVE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_START_DATE <= PER.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0)+
(NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) 
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_START_DATE <= PER.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE
),0))) AS Month_Impair_Adjustments,


-- Deterioro Acum

/*(SELECT SUM(IMPRT.IMPAIRMENT_AMOUNT) FROM FA_IMPAIRMENTS IMPRT 
WHERE  IMPRT.ASSET_ID = BK.ASSET_ID
AND IMPRT.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND IMPRT.STATUS='POSTED'
AND IMPRT.IMPAIRMENT_NAME='DETER') AS Acum_Impair_Adjustments,*/
(NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) *-1
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE
),0) +
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0)-
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0)/*-
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR RESERVE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_START_DATE <= PER.CALENDAR_PERIOD_OPEN_DATE
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0)*/
+
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) 
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE
),0))AS Acum_Impair_Adjustments,

-- Cost Balance
/*FATCS.ADJUSTMENT_AMOUNT - NVL((SELECT SUM(FATHS.DEPRN_AMOUNT) 
FROM FA_DEPRN_DETAIL FATHS, FA_DEPRN_PERIODS PER
WHERE   FATHS.ASSET_ID = BK.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATHS.PERIOD_COUNTER = PER.PERIOD_COUNTER
AND FATHS.DEPRN_SOURCE_CODE = 'D'
--AND :P_START_DATE <= CALENDAR_PERIOD_OPEN_DATE
AND PER.CALENDAR_PERIOD_CLOSE_DATE <= :P_END_DATE),0) AS Cost_Balance,*/
FATCS.ADJUSTMENT_AMOUNT + NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'COST'
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE),0)+ 
NVL((SELECT (SUM(FATADJS.ADJUSTMENT_AMOUNT)*-1) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'COST'
AND (FATADJS.SOURCE_TYPE_CODE = 'ADJUSTMENT'OR FATADJS.SOURCE_TYPE_CODE = 'RETIREMENT')
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE),0)-/*((SELECT MAX(FATHS.DEPRN_RESERVE)
FROM  FA_DEPRN_DETAIL FATHS, FA_DEPRN_PERIODS PER
WHERE   FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATHS.PERIOD_COUNTER = PER.PERIOD_COUNTER
AND FATHS.DEPRN_SOURCE_CODE = 'D'
AND FATHS.DEPRN_AMOUNT <> 0
AND :P_END_DATE >= CALENDAR_PERIOD_CLOSE_DATE
)-NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'RESERVE' 
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE),0))*/(CASE WHEN (SELECT DISTINCT 'Y' FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS 
WHERE  FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID =  FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.ADJUSTMENT_TYPE = 'RESERVE' 
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.TRANSACTION_DATE_ENTERED <= :P_END_DATE
)='Y'THEN 0 ELSE NVL((SELECT SUM(FATHS.DEPRN_AMOUNT)
FROM  FA_DEPRN_DETAIL FATHS, FA_DEPRN_PERIODS PER
WHERE   FATHS.ASSET_ID = BK.ASSET_ID
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATHS.PERIOD_COUNTER = PER.PERIOD_COUNTER
AND FATHS.DEPRN_SOURCE_CODE = 'D'
AND FATHS.DEPRN_AMOUNT <> 0
AND :P_END_DATE >= CALENDAR_PERIOD_CLOSE_DATE
),0)END)+ /*(NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) *-1
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE
),0) +
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0))*/
(NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) *-1
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE
),0) +
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0)-
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT)
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'FULL RETIREMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='RETIREMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'DR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE),0)
+
NVL((SELECT SUM(FATADJS.ADJUSTMENT_AMOUNT) 
FROM FA_TRANSACTION_HEADERS FATHS, FA_ADJUSTMENTS FATADJS , FA_DEPRN_PERIODS PER
WHERE FATHS.ASSET_ID =BK.ASSET_ID
AND FATHS.ASSET_ID = FATADJS.ASSET_ID 
AND FATHS.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATHS.TRANSACTION_TYPE_CODE= 'ADJUSTMENT'
AND FATHS.TRANSACTION_HEADER_ID = FATADJS.TRANSACTION_HEADER_ID
AND FATADJS.SOURCE_TYPE_CODE='ADJUSTMENT'
AND FATADJS.ADJUSTMENT_TYPE = 'IMPAIR EXPENSE'
AND FATADJS.DEBIT_CREDIT_FLAG = 'CR'
AND FATHS.BOOK_TYPE_CODE = PER.BOOK_TYPE_CODE
AND FATADJS.PERIOD_COUNTER_ADJUSTED = PER.PERIOD_COUNTER
AND :P_END_DATE >= PER.CALENDAR_PERIOD_CLOSE_DATE
),0)) AS Cost_Balance,

ACCT_ASSET.SEGMENT2 AS Asset_Cost_Acc,
ACCT_DEPRN.SEGMENT2  AS Depreciation_Expense_Acc,
ACCT_DEPRNR.SEGMENT2 AS Depreciation_Reserve_Acc,
ACCT_DEPRN.SEGMENT5 AS SubProject_Deprn_Expense,
ACCT_INT_EXP.SEGMENT2 AS LeasInterestExp_Acc,

-- Otros
FATH.TRANSACTION_HEADER_ID Transaction_Header_Id,
FATH.TRANSACTION_TYPE_CODE Transaction_Header_Type_Code,
FATAD.ADJUSTMENT_TYPE Adjustment_Type,
FATCS.ADJUSTMENT_TYPE Adjustment_Type_Cost,
BK.DATE_EFFECTIVE BK_DATE_EFFECTIVE,
BK.TRANSACTION_HEADER_ID_IN,
(select V3.MEANING from FND_LOOKUP_VALUES V3 where V3.LOOKUP_CODE = BOOK.LEASE_TYPE_CODE and V3.Language = 'E') Lease_Type

,(SELECT MIN(BOOK_ED.DATE_EFFECTIVE)
FROM FA_LEASE_BOOKS BOOK_ED WHERE BOOK_ED.LEASE_ID = LEASE.LEASE_ID 
AND BOOK_ED.BOOK_TYPE_CODE = BOOK.BOOK_TYPE_CODE
AND BOOK_ED.LEASE_TRANSACTION_TYPE_CODE = 'ADDITION' ) AS Addition_Date

FROM FA_LEASES LEASE,
FA_LEASE_BOOKS BOOK,
FA_BOOKS BK,
FA_LEASE_SCHEDULES FSCHED,
FA_ADDITIONS_B ASSETS,
FA_ASSET_HISTORY HIST,
FA_CATEGORIES_B CATEGORY,
FA_CATEGORY_BOOKS FACATEG,
FA_CATEGORY_BOOKS CATBK,
FA_METHODS FMD,
POZ_SUPPLIERS LESSOR,
POZ_SUPPLIERS_PII LESSOR1,
HZ_PARTIES HZ,
HR_ORGANIZATION_UNITS_F_TL haotl,
HR_ALL_ORGANIZATION_UNITS_F_VL BU,
FA_DISTRIBUTION_HISTORY  FADH,
GL_CODE_COMBINATIONS GL_CC,
GL_CODE_COMBINATIONS ACCT_ASSET,
GL_CODE_COMBINATIONS ACCT_DEPRN,
GL_CODE_COMBINATIONS ACCT_DEPRNR,
GL_CODE_COMBINATIONS ACCT_INT_EXP,
FA_TRANSACTION_HEADERS FATH,
FA_ADJUSTMENTS  FATAD,
FA_ADJUSTMENTS  FATCS,
FA_CATEGORIES_B CATB,
FA_DEPRN_PERIODS DEPRNPER

WHERE  LEASE.LEASE_ID = BOOK.LEASE_ID
AND BK.LEASE_ID = BK.LEASE_ID
AND BK.BOOK_TYPE_CODE = BOOK.BOOK_TYPE_CODE
AND LEASE.LEASE_ID = FSCHED.LEASE_ID 
AND FSCHED.ASSET_ID =  BK.ASSET_ID
AND FSCHED.LEASE_SCHEDULE_ID = BK.LEASE_SCHEDULE_ID
AND FSCHED.ASSET_ID =  ASSETS.ASSET_ID
AND ASSETS.ASSET_CATEGORY_ID =CATEGORY.CATEGORY_ID
AND BK.METHOD_ID = FMD.METHOD_ID
AND LEASE.BU_ID = BU.ORGANIZATION_ID 
AND BU.ORGANIZATION_ID = HAOTL.ORGANIZATION_ID AND HAOTL.LANGUAGE = USERENV('LANG')
AND LEASE.LESSOR_ID = LESSOR.VENDOR_ID
AND LESSOR.VENDOR_ID= LESSOR1.VENDOR_ID
AND LESSOR.PARTY_ID  = HZ.PARTY_ID
AND FADH.ASSET_ID =  ASSETS.ASSET_ID
AND FADH.BOOK_TYPE_CODE = BOOK.BOOK_TYPE_CODE
AND FADH.ASSET_ID =  BK.ASSET_ID
AND FSCHED.ASSET_ID = FADH.ASSET_ID
AND FADH.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FADH.CODE_COMBINATION_ID(+) =GL_CC.CODE_COMBINATION_ID

--Category History
AND ASSETS.ASSET_ID = HIST.ASSET_ID
/*AND HIST.DATE_EFFECTIVE = (SELECT MAX(C_HIST.DATE_EFFECTIVE) FROM FA_ASSET_HISTORY  C_HIST WHERE HIST.ASSET_ID = C_HIST.ASSET_ID AND HIST.ASSET_TYPE= C_HIST.ASSET_TYPE  
AND C_HIST.DATE_EFFECTIVE <= :P_END_DATE)*/
/*AND HIST.DATE_EFFECTIVE = NVL((SELECT MAX(C_HIST.DATE_EFFECTIVE) FROM FA_ASSET_HISTORY  C_HIST WHERE HIST.ASSET_ID = C_HIST.ASSET_ID AND HIST.ASSET_TYPE= C_HIST.ASSET_TYPE AND C_HIST.DATE_EFFECTIVE <= :P_END_DATE
),(SELECT MAX(C_HIST.DATE_EFFECTIVE) FROM FA_ASSET_HISTORY  C_HIST WHERE HIST.ASSET_ID = C_HIST.ASSET_ID AND HIST.ASSET_TYPE= C_HIST.ASSET_TYPE AND C_HIST.DATE_EFFECTIVE >= :P_START_DATE
))*/
AND HIST.DATE_EFFECTIVE = (SELECT MAX(C_HIST.DATE_EFFECTIVE) FROM FA_ASSET_HISTORY  C_HIST, FA_TRANSACTION_HEADERS TRAH WHERE HIST.ASSET_ID = C_HIST.ASSET_ID 
AND HIST.ASSET_TYPE= C_HIST.ASSET_TYPE AND HIST.BOOK_TYPE_CODE= C_HIST.BOOK_TYPE_CODE
AND C_HIST.ASSET_ID=TRAH.ASSET_ID
AND TRAH.BOOK_TYPE_CODE= C_HIST.BOOK_TYPE_CODE
AND C_HIST.TRANSACTION_HEADER_ID_IN= TRAH.TRANSACTION_HEADER_ID
AND TRAH.TRANSACTION_DATE_ENTERED <= :P_END_DATE
)
AND CATBK.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND CATBK.CATEGORY_ID = HIST.CATEGORY_ID
AND CATBK.DEPRN_EXPENSE_ACCOUNT_CCID = ACCT_DEPRN.CODE_COMBINATION_ID
AND HIST.CATEGORY_ID=CATB.CATEGORY_ID


--Category Lease Accounts

AND FACATEG.BOOK_TYPE_CODE   =  BK.BOOK_TYPE_CODE
AND CATEGORY.CATEGORY_ID = FACATEG.CATEGORY_ID
AND FACATEG.ASSET_COST_ACCOUNT_CCID = ACCT_ASSET.CODE_COMBINATION_ID

AND FACATEG.BOOK_TYPE_CODE   =  BK.BOOK_TYPE_CODE
AND CATEGORY.CATEGORY_ID = FACATEG.CATEGORY_ID
/*AND FACATEG.DEPRN_EXPENSE_ACCOUNT_CCID = ACCT_DEPRN.CODE_COMBINATION_ID*/

AND FACATEG.BOOK_TYPE_CODE   =  BK.BOOK_TYPE_CODE
AND CATEGORY.CATEGORY_ID = FACATEG.CATEGORY_ID
AND FACATEG.RESERVE_ACCOUNT_CCID = ACCT_DEPRNR.CODE_COMBINATION_ID

AND FACATEG.BOOK_TYPE_CODE   =  BK.BOOK_TYPE_CODE
AND CATEGORY.CATEGORY_ID = FACATEG.CATEGORY_ID
AND FACATEG.LEASE_INT_EXPENSE_ACCOUNT_CCID = 
ACCT_INT_EXP.CODE_COMBINATION_ID

-- Addition Only
AND FATH.BOOK_TYPE_CODE = BK.BOOK_TYPE_CODE
AND FATH.ASSET_ID =  BK.ASSET_ID
AND FATH.TRANSACTION_TYPE_CODE = 'ADDITION'


-- Lease Liabilty - CR
AND  FATAD.BOOK_TYPE_CODE  =   FATH.BOOK_TYPE_CODE 
AND  FATAD.ASSET_ID   =   FATH.ASSET_ID 
AND  FATAD.TRANSACTION_HEADER_ID=   FATH.TRANSACTION_HEADER_ID
AND  FATAD.ADJUSTMENT_TYPE='LEASE LIABILITY'
--AND  FATAD.DEBIT_CREDIT_FLAG = 'CR'

-- Cost - DR
AND  FATCS.BOOK_TYPE_CODE  =   FATH.BOOK_TYPE_CODE 
AND  FATCS.ASSET_ID   =   FATH.ASSET_ID 
AND  FATCS.TRANSACTION_HEADER_ID=   FATH.TRANSACTION_HEADER_ID
AND  FATCS.ADJUSTMENT_TYPE='COST'
--AND  FATCS.DEBIT_CREDIT_FLAG = 'DR'
AND FATCS.BOOK_TYPE_CODE= DEPRNPER.BOOK_TYPE_CODE
AND DEPRNPER.PERIOD_COUNTER= FATCS.PERIOD_COUNTER_CREATED

--Date filters
--AND BOOK.DATE_EFFECTIVE BETWEEN :P_START_DATE AND :P_END_DATE


-- Effective Dates
AND BOOK.DATE_EFFECTIVE = (SELECT MAX(BOOK_ED.DATE_EFFECTIVE)
FROM FA_LEASE_BOOKS BOOK_ED WHERE BOOK_ED.LEASE_ID = LEASE.LEASE_ID 
AND BOOK_ED.BOOK_TYPE_CODE = BOOK.BOOK_TYPE_CODE)
--AND BOOK_ED.DATE_EFFECTIVE BETWEEN :P_START_DATE AND :P_END_DATE)

AND BK.DATE_EFFECTIVE = (SELECT MAX(BK_ED.DATE_EFFECTIVE)
FROM FA_BOOKS BK_ED WHERE BK_ED.LEASE_ID = BOOK.LEASE_ID 
AND BK_ED.BOOK_TYPE_CODE = BOOK.BOOK_TYPE_CODE
AND BK_ED.ASSET_ID = BK.ASSET_ID)
--AND BK_ED.DATE_EFFECTIVE BETWEEN :P_START_DATE AND :P_END_DATE)
AND FADH.DATE_EFFECTIVE = (SELECT MAX(FADH_ED.DATE_EFFECTIVE)
FROM FA_DISTRIBUTION_HISTORY FADH_ED , FA_TRANSACTION_HEADERS HDR
WHERE FADH_ED.BOOK_TYPE_CODE = BOOK.BOOK_TYPE_CODE
AND FADH_ED.ASSET_ID = FSCHED.ASSET_ID
--AND FADH_ED.DATE_EFFECTIVE <= :P_END_DATE)
AND FADH_ED.TRANSACTION_HEADER_ID_IN= HDR.TRANSACTION_HEADER_ID
AND FADH_ED.BOOK_TYPE_CODE = HDR.BOOK_TYPE_CODE
AND HDR.TRANSACTION_DATE_ENTERED <= :P_END_DATE)
--AND FADH_ED.DATE_EFFECTIVE BETWEEN :P_START_DATE AND :P_END_DATE)

-- Paramenters
AND BU.NAME = :P_BU
AND BOOK.BOOK_TYPE_CODE = :P_BOOK
--AND FSCHED.DATE_EFFECTIVE BETWEEN :P_START_DATE AND :P_END_DATE
--AND BK.DATE_EFFECTIVE BETWEEN :P_START_DATE AND :P_END_DATE
--AND  (to_char(:P_START_DATE, 'YYYY') >=  to_char(LEASE.LEASE_START_DATE, 'YYYY')
--AND to_char(:P_START_DATE, 'MM') >=  to_char(LEASE.LEASE_START_DATE, 'MM'))
--AND  ( to_char(LEASE.LEASE_START_DATE, 'YYYY')  >= to_char(:P_START_DATE, 'YYYY')
--AND to_char(LEASE.LEASE_START_DATE, 'MM') >= to_char(:P_START_DATE, 'MM') )
--AND  :P_END_DATE  <= BOOK.LEASE_END_DATE
--AND  LEASE.LEASE_START_DATE <= :P_END_DATE
AND DEPRNPER.FISCAL_YEAR<=to_char( :P_END_DATE,'YYYY')
AND DEPRNPER.PERIOD_NUM<=to_char( :P_END_DATE,'MM')
--AND  to_char(:P_END_DATE  , 'YYYYMM') <=  to_char(BOOK.LEASE_END_DATE, 'YYYYMM')
AND (LEASE_NUMBER = :P_LEASE_NUMBER OR ' ' = :P_LEASE_NUMBER OR :P_LEASE_NUMBER IS NULL)
AND FSCHED.SCHEDULE_TYPE_CODE = 'A'
AND (FSCHED.ASSET_NUMBER  =:P_ASSET_NUMBER OR ' ' = :P_ASSET_NUMBER OR :P_ASSET_NUMBER IS NULL)
ORDER BY LEASE_NUMBER ASC
